# 代码清理变更记录（四轮优化）

> 基准提交：`2fac2c0`（本次所有改动均基于此提交）
> 还原方法：`git checkout 2fac2c0 -- <文件路径>` 即可恢复单个文件

---

## 一、前端清理

### 1.1 删除零使用 El* wrapper 组件（第三轮）

三个组件在全项目无任何引用，直接删除文件并移除 `ui.ts` 中的注册。

| 删除文件 | 说明 |
|----------|------|
| `frontend/src/components/app/ElDatePicker.vue` | 日期选择器 wrapper，无页面使用 |
| `frontend/src/components/app/ElDivider.vue` | 分割线 wrapper，无页面使用 |
| `frontend/src/components/app/ElLink.vue` | 链接 wrapper，无页面使用 |

**关联修改**：`frontend/src/plugins/ui.ts` — 移除以上 3 个组件的 import 和 `app.component()` 注册。

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/frontend/src/components/app/ElDatePicker.vue" \
  "Auto_All_System_Web/frontend/src/components/app/ElDivider.vue" \
  "Auto_All_System_Web/frontend/src/components/app/ElLink.vue" \
  "Auto_All_System_Web/frontend/src/plugins/ui.ts"
```

### 1.2 删除未使用的前端文件（前两轮）

| 删除文件 | 说明 |
|----------|------|
| `frontend/src/api/bitbrowser.ts` | 比特浏览器 API 封装，已被后端统一管理替代 |
| `frontend/src/router/modules/google.ts` | Google 专区路由，已合并到主路由 |
| `frontend/src/router/modules/gpt.ts` | GPT 专区路由，已合并到主路由 |
| `frontend/scripts/shadcn_sync.py` | Shadcn 组件同步脚本，一次性使用 |

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/frontend/src/api/bitbrowser.ts" \
  "Auto_All_System_Web/frontend/src/router/modules/google.ts" \
  "Auto_All_System_Web/frontend/src/router/modules/gpt.ts" \
  "Auto_All_System_Web/frontend/scripts/shadcn_sync.py"
```

---

## 二、后端清理

### 2.1 移除未使用 import（第四轮 · 操作 1）

**文件**：`backend/plugins/google_business/services/bind_card_service.py`

删除 3 行未使用导入：
- `from django.utils import timezone`
- `from apps.integrations.google_accounts.models import GoogleAccount`
- `from ..models import GoogleTask, GoogleCardInfo`

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/backend/plugins/google_business/services/bind_card_service.py"
```

### 2.2 修复 24 处裸 `except:` → `except Exception:`（第四轮 · 操作 2）

裸 `except:` 会捕获 `KeyboardInterrupt`、`SystemExit` 等不应静默吞掉的异常。

| 文件 | 修改行数 |
|------|----------|
| `backend/apps/accounts/admin.py` | 1 处（注：此文件通过 `models.py` 的 `except:` 同类修复链带入） |
| `backend/apps/integrations/models.py` | 1 处 |
| `backend/apps/integrations/google_accounts/two_fa.py` | 1 处 |
| `backend/plugins/google_business/serializers.py` | 2 处 |
| `backend/plugins/google_business/services/bind_card_service.py` | 12 处 |
| `backend/plugins/google_business/services/link_service.py` | 2 处 |
| `backend/plugins/google_business/services/login_service.py` | 5 处 |
| `backend/plugins/google_business/services/verify_service.py` | 1 处 |

**还原**（全部 7 个文件）：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/backend/apps/integrations/models.py" \
  "Auto_All_System_Web/backend/apps/integrations/google_accounts/two_fa.py" \
  "Auto_All_System_Web/backend/plugins/google_business/serializers.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/bind_card_service.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/link_service.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/login_service.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/verify_service.py"
```

### 2.3 清理 `asgi.py` 注释（第四轮 · 操作 3）

**文件**：`backend/config/asgi.py`

移除引用不存在的 `apps.tasks.routing` 注释，改为清晰占位说明。

**还原**：
```bash
git checkout 2fac2c0 -- "Auto_All_System_Web/backend/config/asgi.py"
```

### 2.4 移除 DEBUG print（第四轮 · 操作 4）

**文件**：`backend/plugins/gpt_business/tasks.py`

删除 10 处 `print("[DEBUG]...")` 语句（均有对应 `_log()` 调用，不丢失日志），1 处改为 `logger.debug()`。

**还原**：
```bash
git checkout 2fac2c0 -- "Auto_All_System_Web/backend/plugins/gpt_business/tasks.py"
```

### 2.5 替换 print → logger（第四轮 · 操作 5）

**文件**：`backend/plugins/gpt_business/services/protocol_keygen.py`

524-670 行范围内 14 处 `print(...)` 替换为 `logger.info/warning/error`。
新增 `import logging` 和 `logger = logging.getLogger(__name__)`。

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/backend/plugins/gpt_business/services/protocol_keygen.py"
```

### 2.6 替换 print → logger（第四轮 · 操作 6）

**文件**：`backend/apps/integrations/bitbrowser/api.py`

2 处 `print(...)` 替换为 `logger.error(...)`。
新增 `import logging` 和 `logger = logging.getLogger(__name__)`。

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/backend/apps/integrations/bitbrowser/api.py"
```

### 2.7 删除死代码和废弃文件（前两轮）

| 删除文件 | 说明 |
|----------|------|
| `backend/plugins/google_business/services/gemini.py` | Gemini 服务，已废弃未被调用 |
| `backend/plugins/google_business/services/sheerid.py` | SheerID 服务，已废弃未被调用 |
| `backend/libs/__init__.py` | 空包标识，libs 目录已独立管理 |
| `backend/reset_password.py` | 移至 `backend/scripts/reset_password.py` |
| `backend/update_payment_names.py` | 一次性迁移脚本 |
| `backend/update_env_for_docker.sh` | 移至 `backend/scripts/update_env_for_docker.sh` |
| `backend/scripts/generate_remaining_files.py` | 一次性代码生成脚本 |
| `backend/scripts/init_payment_config.py` | 一次性初始化脚本 |

**关联修改**：`backend/plugins/google_business/services/__init__.py` — 移除 `SheerIDService` 和 `GeminiService` 的导入和导出。

**关联修改**：`backend/apps/integrations/models.py` — 移除 `get_api_key()` 中的 2 行死代码（重复的 Fernet 解密逻辑，永远不会执行）。

**还原**：
```bash
git checkout 2fac2c0 -- \
  "Auto_All_System_Web/backend/plugins/google_business/services/gemini.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/sheerid.py" \
  "Auto_All_System_Web/backend/plugins/google_business/services/__init__.py" \
  "Auto_All_System_Web/backend/apps/integrations/models.py" \
  "Auto_All_System_Web/backend/libs/__init__.py" \
  "Auto_All_System_Web/backend/reset_password.py" \
  "Auto_All_System_Web/backend/update_payment_names.py" \
  "Auto_All_System_Web/backend/update_env_for_docker.sh" \
  "Auto_All_System_Web/backend/scripts/generate_remaining_files.py" \
  "Auto_All_System_Web/backend/scripts/init_payment_config.py"
```

---

## 三、项目级文件清理

| 删除文件 | 说明 |
|----------|------|
| `DEVNOTES.md` | 旧开发笔记，内容已过时 |
| `REFACTOR_PLAN.md` | 重构计划，已完成 |
| `SYSTEM_STATUS.md` | 系统状态文档，内容过时 |
| `docs/README.md` | 旧文档索引，已被 `docs/文档索引.md` 替代 |
| `best-practices-sensitive-tokens-task-logs.md` | 最佳实践备忘，已落地到代码 |
| `docker-compose.dev.yml` | 开发环境 compose，已合并到主 compose |
| `package-lock.json` | 根目录误放的 lock 文件 |
| `一键启动_hostnet.sh` | 旧启动脚本 |
| `开发模式启动_hostnet.sh` | 旧启动脚本 |
| `backend/plugins/google_business/docs/AUTOMATION_MAINTENANCE.md` | 已替换为中文版 |
| `backend/plugins/gpt_business/docs/AUTOMATION_FLOW.md` | 已替换为中文版 |
| `backend/plugins/gpt_business/docs/AUTO_INVITE_MAINTENANCE.md` | 已替换为中文版 |

**还原**（全部还原）：
```bash
git checkout 2fac2c0 -- \
  "DEVNOTES.md" \
  "Auto_All_System_Web/REFACTOR_PLAN.md" \
  "Auto_All_System_Web/SYSTEM_STATUS.md" \
  "Auto_All_System_Web/docs/README.md" \
  "Auto_All_System_Web/best-practices-sensitive-tokens-task-logs.md" \
  "Auto_All_System_Web/docker-compose.dev.yml" \
  "Auto_All_System_Web/package-lock.json" \
  "Auto_All_System_Web/一键启动_hostnet.sh" \
  "Auto_All_System_Web/开发模式启动_hostnet.sh" \
  "Auto_All_System_Web/backend/plugins/google_business/docs/AUTOMATION_MAINTENANCE.md" \
  "Auto_All_System_Web/backend/plugins/gpt_business/docs/AUTOMATION_FLOW.md" \
  "Auto_All_System_Web/backend/plugins/gpt_business/docs/AUTO_INVITE_MAINTENANCE.md"
```

---

## 四、一键全量还原

如果需要还原本次所有改动：

```bash
# 回到基准提交状态（仅针对 Web 模块 + DEVNOTES）
git checkout 2fac2c0 -- Auto_All_System_Web/ DEVNOTES.md
```

---

## 五、未修改（记录备查）

以下问题在审核中发现但**未做修改**，记录以备后续处理：

| 问题 | 说明 |
|------|------|
| `settings/base.py` 硬编码默认密码 | `DB_PASSWORD` 等有不安全默认值，属配置策略 |
| CLI 脚本中的 print | `init_system.py`、`scripts/reset_password.py` 中 print 是合理输出 |
| `two_fa.py:113-121` 的 print | `__main__` 调试入口，可接受 |
| `celery.py:21` 的 print | Celery `debug_task` 标准示例 |
| `protocol_keygen.py` 789+ 行的 print | 注册流程大量步骤日志，需整体重构为 logger，不在本轮范围 |
| 8 处 TODO 注释 | 均为待实现业务逻辑，非技术债务 |
