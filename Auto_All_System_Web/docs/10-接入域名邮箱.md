# 域名邮箱服务集成

基于 Cloud Mail 自建邮箱系统的集成方案，用于自动创建辅助邮箱和接收验证码。

## 功能概述

- **自动创建域名邮箱** - 为 Google 账号生成专属辅助邮箱
- **接收验证码** - 轮询等待并自动提取 6 位验证码
- **一对一绑定** - 每个 Google 账号绑定一个辅助邮箱

---

## 快速开始

### 1. 运行数据库迁移

```bash
cd Auto_All_System_Web/backend
python manage.py makemigrations email_service
python manage.py migrate
```

### 2. 获取 API Token

```bash
curl -X POST https://mail.180711.xyz/api/public/genToken \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@yourdomain.com", "password": "your-password"}'
```

响应:
```json
{"code": 200, "data": {"token": "9f4e298e-7431-4c76-bc15-..."}}
```

### 3. 在 Django Admin 配置

访问 `http://localhost:8000/admin/`，登录后找到 **邮件服务 → Cloud Mail配置**，添加配置：

| 字段 | 示例值 |
|------|--------|
| 名称 | `主服务` |
| API地址 | `https://mail.180711.xyz/api/public` |
| API Token | `9f4e298e-7431-4c76-bc15-...` |
| 域名 | `["pigll.site", "pigll.indevs.in", "pigzwy.cc.cd"]` |
| 默认角色 | `gpt-team` |
| 是否默认 | ✓ |
| 是否启用 | ✓ |

---

## 使用方法

### 基础用法

```python
from apps.integrations.email.services import EmailService

service = EmailService()

# 1. 为 Google 账号创建辅助邮箱
email, password = service.create_recovery_email(google_account)
print(f"创建辅助邮箱: {email}")

# 2. 等待 Google 验证码（触发验证邮件后调用）
code = service.get_google_verification_code(email, timeout=120)
if code:
    print(f"验证码: {code}")
```

### 直接使用 API 客户端

```python
from apps.integrations.email.services import CloudMailClient

# 从数据库配置创建客户端
client = CloudMailClient.from_config()

# 创建随机邮箱
email, password = client.create_random_user()

# 等待任意验证码
code = client.wait_for_verification_code(email, timeout=60)
```

### 在安全设置流程中使用

```python
async def change_recovery_email_with_verification(page, google_account):
    """修改辅助邮箱并自动验证"""
    from apps.integrations.email.services import EmailService
    
    service = EmailService()
    
    # 1. 创建新的辅助邮箱
    new_email, password = service.create_recovery_email(google_account)
    
    # 2. 在页面上填写新邮箱（触发验证邮件）
    await page.fill('input[name="recovery-email"]', new_email)
    await page.click('button[type="submit"]')
    
    # 3. 等待验证码
    code = service.get_google_verification_code(new_email, timeout=120)
    
    if code:
        # 4. 填写验证码
        await page.fill('input[name="code"]', code)
        await page.click('button[type="submit"]')
        return True, new_email
    
    return False, "获取验证码超时"
```

---

## 文件结构

```
apps/integrations/email/
├── __init__.py           # 模块入口
├── apps.py               # Django app 配置
├── models.py             # 数据模型
├── admin.py              # Admin 管理界面
├── README.md             # 模块文档
└── services/
    ├── __init__.py       # 服务导出
    ├── client.py         # CloudMailClient (API 封装)
    └── email_service.py  # EmailService (业务逻辑)
```

---

## API 参考

### EmailService

高层业务服务，推荐使用。

```python
service = EmailService()
```

| 方法 | 说明 |
|------|------|
| `create_recovery_email(google_account)` | 创建辅助邮箱并绑定，返回 (email, password) |
| `get_verification_code(email, timeout)` | 等待并提取验证码 |
| `get_google_verification_code(email)` | 获取 Google 验证码（预设发件人过滤） |

### CloudMailClient

底层 API 客户端。

```python
client = CloudMailClient.from_config()
# 或手动配置
client = CloudMailClient(
    api_base="https://mail.180711.xyz/api/public",
    api_token="your-token",
    domains=["pigll.site"],
    default_role="user"
)
```

| 方法 | 说明 |
|------|------|
| `create_user(email, password?, role?)` | 创建指定邮箱用户 |
| `create_random_user(domain?)` | 创建随机邮箱，返回 (email, password) |
| `list_emails(to_email, ...)` | 查询邮件列表 |
| `wait_for_email(to_email, timeout)` | 等待新邮件到达 |
| `wait_for_verification_code(to_email, timeout)` | 等待并提取验证码 |
| `extract_verification_code(email)` | 从邮件中提取 6 位验证码 |

---

## 数据模型

### CloudMailConfig

Cloud Mail API 配置，在 Django Admin 中管理。

| 字段 | 类型 | 说明 |
|------|------|------|
| name | CharField | 配置名称 |
| api_base | URLField | API 基础地址 |
| api_token | CharField | API Token |
| domains | JSONField | 可用域名列表 |
| default_role | CharField | 默认用户角色 |
| is_default | BooleanField | 是否默认配置 |
| is_active | BooleanField | 是否启用 |

### RecoveryEmail

辅助邮箱记录，与 GoogleAccount 一对一关联。

| 字段 | 类型 | 说明 |
|------|------|------|
| email | EmailField | 邮箱地址 |
| password | CharField | 密码 |
| google_account | OneToOneField | 绑定的 Google 账号 |
| owner | ForeignKey | 所有者 |

---

## 模糊匹配语法

查询邮件时支持 SQL LIKE 语法：

| 模式 | 说明 |
|------|------|
| `admin` | 精确匹配 |
| `admin%` | 以 admin 开头 |
| `%@example.com` | 以 @example.com 结尾 |
| `%验证码%` | 包含"验证码" |

---

## 注意事项

1. **先创建用户才能收信** - Cloud Mail 不是临时邮箱，需要先创建用户
2. **Token 全局唯一** - 重新生成 Token 会使旧 Token 失效
3. **验证码超时** - 默认 120 秒，可根据网络情况调整
4. **邮件类型** - type=0 收件，type=1 发件

---

## 相关链接

- Cloud Mail 项目: https://github.com/maillab/cloud-mail
- API 文档: https://doc.skymail.ink/api/api-doc.html
- Web 界面: https://mail.180711.xyz
