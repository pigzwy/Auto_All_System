# 前端 UI 问题快速定位手册（Runbook）

适用范围：`Auto_All_System_Web` 前端（Vue 3 + shadcn-vue/reka-ui + 项目内 `El*` 兼容层）。

目标：当出现“接口有返回但 UI 不更新 / 弹窗打不开 / Console 一堆 Teleport 警告”等问题时，能在 5-10 分钟内定位到**是哪一层坏了**，并快速给出可复用的修复方式。

---

## 0. 快速分流：到底是“数据没变”还是“UI 没刷新”？

先做 3 件事（顺序固定）：

1. 看 Network
   - 请求有没有发出去？方法是否正确（GET/PATCH/POST）？
   - Response body 里目标字段是否真的变化（例如 `is_active`）？
2. 看 Console
   - 有没有 Vue warning（尤其是 Teleport/Portal 的 attrs 警告）
   - 有没有运行时 error（组件渲染失败会导致“整列不显示/按钮无响应”）
3. 看全局组件映射
   - 很多页面用的是全局组件别名（看起来像 Element UI，但其实是项目封装）。
   - 映射位置：`frontend/src/plugins/ui.ts`

---

## 1. 这个项目的 UI 体系：最容易踩坑的 4 个全局映射

在 `frontend/src/plugins/ui.ts` 里，全局注册了兼容层组件（Legacy wrapper）。

排障时务必先确认你用的是什么：

1. `Toggle` -> `frontend/src/components/app/ElSwitch.vue`
2. `Modal` -> `frontend/src/components/app/ElDialog.vue`
3. `DataTable` -> `frontend/src/components/app/ElTable.vue`
4. `DataColumn` -> `frontend/src/components/app/ElTableColumn.vue`

很多“看起来是页面问题”的 bug，其实出在这些封装层。

---

## 2. 高频故障 1：Console 刷屏 Teleport/Portal 警告（style/class 失效）

### 现象

Console 出现大量：

`[Vue warn]: Extraneous non-props attributes (style) were passed to component ... teleport root nodes`

常见伴随现象：
- 你传了 `style="max-width: 600px"` 之类的样式，但弹窗宽度没变
- 下拉菜单/弹窗样式异常

### 根因

组件根节点是 `Portal/Teleport`（或者多根节点 fragment），Vue 不能自动把 `$attrs`（如 `style` / `class`）“继承”到真实 DOM 上。

### 快速定位

1. 直接看 warning 的组件栈顶，一般会出现 `DialogPortal / SelectPortal / DropdownMenuPortal`
2. 找对应 wrapper：通常在 `frontend/src/components/ui/**/`

已确认存在 Portal 的 wrapper（项目内）：
- `frontend/src/components/ui/dialog/DialogContent.vue`（`DialogPortal`）
- `frontend/src/components/ui/dialog/DialogScrollContent.vue`（`DialogPortal`）
- `frontend/src/components/ui/sheet/SheetContent.vue`（`DialogPortal`）
- `frontend/src/components/ui/select/SelectContent.vue`（`SelectPortal`）
- `frontend/src/components/ui/dropdown-menu/DropdownMenuContent.vue`（`DropdownMenuPortal`）
- `frontend/src/components/ui/dropdown-menu/DropdownMenuSubContent.vue`（SubContent 也会涉及 attrs 透传）

### 标准修复模板（可复制）

要点只有两个：

1) 禁用自动继承

```vue
<script setup lang="ts">
defineOptions({
  inheritAttrs: false,
})
</script>
```

2) 把 `$attrs` 明确绑定到“真实内容节点”上，而不是 Portal 组件上

```vue
<template>
  <SomePortal>
    <SomeContent v-bind="{ ...forwarded, ...$attrs }">...</SomeContent>
  </SomePortal>
</template>
```

参考（Vue 官方）：Fallthrough Attributes / 多根节点属性继承。

---

## 3. 高频故障 2：接口有返回，但表格不渲染 / 只显示某一列

### 现象

- Network 里能看到接口返回（例如 `/api/v1/email/configs/` 有 `results`）
- 但页面表格空白，或只剩下“能直接用 `row[prop]` 渲染的列”（例如只显示 `id`）

### 根因（常见于自定义 Table 封装）

两类常见坑：

1) 在 `<script setup>` 里把 `props` 解构成普通变量，再在 template 里用
   - 例如：`const { data } = props` 然后 template 里 `v-for="row in data"`
   - 结果：父组件更新 `props.data` 后，template 不一定触发更新（尤其是异步加载）
2) slot 渲染器写成普通函数/不正确的组件形态
   - 会导致 `DataColumn` 的 `#default` 插槽不稳定或不渲染

### 快速定位

`/admin/*` 页面里出现 DataTable 的地方，第一时间去看：

- `frontend/src/components/app/ElTable.vue`

### 标准修复方向（封装层）

- template 里优先直接用 `props.xxx`，不要依赖解构出来的变量
- 需要渲染 slot 时，用 `defineComponent()` 包一层 renderer（render function），不要直接把 slotFn 当普通函数返回

---

## 4. 高频故障 3：开关/Toggle 触发了请求，但 UI 图标不变

### 现象

- 你能看到 PATCH 请求已经发出并成功
- 但开关视觉状态不更新（像“没点到”）

### 根因（本项目最典型的一类）

`Toggle` 不是直接用的 reka-ui 组件，而是链路：

`Toggle (全局)` -> `ElSwitch.vue (兼容层)` -> `components/ui/switch/Switch.vue` -> `reka-ui SwitchRoot`

关键点：`reka-ui SwitchRoot` 的受控协议是：

- Prop：`modelValue`
- Event：`update:modelValue`

证据：`frontend/node_modules/reka-ui/src/Switch/SwitchRoot.vue`

同时，项目内的 shadcn Switch wrapper 也直接透传了 `SwitchRootProps`：

- `frontend/src/components/ui/switch/Switch.vue`

所以如果你在封装/使用时写成 `checked/update:checked`，**有很大概率 UI 永远不跟数据走**。

### 快速定位

1) 先确认你用的是 `Toggle` 还是 `Switch`
   - `Toggle`：看 `frontend/src/plugins/ui.ts`，实际是 `ElSwitch.vue`
   - `Switch`：`frontend/src/components/ui/switch/Switch.vue`
2) 再确认事件/prop 是否匹配 `modelValue/update:modelValue`

---

## 5. 高频故障 4：点“新增”没反应 / 弹窗永远打不开

### 现象

- 点击按钮后没有任何变化
- Console 没报错，Network 也没请求

### 根因

很大概率还是“封装层 reactivity 丢失”：

例如在 `ElDialog` 这类组件里，把 `props` 解构成普通变量，再在 template 里用，会导致 `modelValue` 不响应。

### 快速定位

看全局映射：
- `Modal` -> `frontend/src/components/app/ElDialog.vue`

排查点：
- 是否存在 `const { modelValue } = props` 并在 template 用 `modelValue`
- 正确写法：`toRefs(props)` 或直接 `props.modelValue`

---

## 6. 全库快速自检命令（没有 rg 就用 git grep/grep）

1) 找所有 Portal/Teleport wrapper

```bash
git grep -n "Portal" frontend/src/components/ui -- '*.vue'
git grep -n "<Teleport" frontend/src/components/ui -- '*.vue'
```

2) 找 inheritAttrs 修复是否齐全

```bash
git grep -n "inheritAttrs: false" frontend/src/components/ui -- '*.vue'
```

3) 找 props 解构（高风险点，需要人工确认是否在 template 使用）

```bash
git grep -n "const {" frontend/src/components/app -- '*.vue'
git grep -n "= props" frontend/src/components/app -- '*.vue'
```

4) 确认 Switch/Toggle 协议

```bash
# Reka UI SwitchRoot 的真实协议
git grep -n "modelValue" frontend/node_modules/reka-ui/src/Switch/SwitchRoot.vue

# 项目 Switch wrapper
git grep -n "SwitchRoot" frontend/src/components/ui/switch/Switch.vue

# Toggle 的全局映射
git grep -n "app.component('Toggle'" frontend/src/plugins/ui.ts
```

---

## 7. 典型案例：`/admin/email` 一次故障定位路径（参考模板）

当你在 `/admin/email` 看到：
- 接口 `/api/v1/email/configs/` 有数据
- 表格不显示 / 开关不变 / 弹窗打不开 / Console 警告很多

按这个顺序定位：

1) DataTable 映射：`frontend/src/plugins/ui.ts` -> `DataTable` -> `ElTable.vue`
2) Toggle 映射：`frontend/src/plugins/ui.ts` -> `Toggle` -> `ElSwitch.vue` -> `SwitchRoot(modelValue)`
3) Dialog/Dropdown 的 Portal attrs 警告：到 `frontend/src/components/ui/**/` 查 `inheritAttrs` + `$attrs` 透传

---

## 8. 预防清单（Code Review 时快速扫一眼）

1) 任何 `Portal/Teleport` wrapper：必须 `inheritAttrs: false` + `v-bind="{...$attrs}"`
2) 任何 `Switch`/`Toggle` wrapper：先确认底层库协议（Reka UI 是 `modelValue`）
3) 任何 `<script setup>`：不要 `const { x } = props` 后把 `x` 用在 template 里（用 `toRefs` 或 `props.x`）
4) Table/slot 渲染：slot renderer 用 `defineComponent`（不要裸函数返回 VNode）
