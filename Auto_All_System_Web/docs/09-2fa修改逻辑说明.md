# 09 - 安全设置：修改 2FA 密钥（实现逻辑说明）

本文档说明 Google 专区「安全设置 -> 修改 2FA」的后端实现逻辑、浏览器自动化流程、数据写回方式以及常见问题。

结论先说
- 该功能不是调用 Google 官方开放 API（OAuth/Admin API）来修改 2FA。
- 实现方式是：后端 Celery 任务通过 Playwright 连接到 GeekezBrowser 的浏览器实例（CDP），像真人一样访问 Google Account 设置页面并完成操作。
- 新的 2FA 密钥通过页面元素抓取获得，并加密写回系统数据库；同时也会作为 Celery 任务结果返回（当前实现会返回明文，属于敏感信息）。

## 1. 入口 API

前端点击「安全设置 -> 修改 2FA」会请求后端：

```http
POST /api/v1/plugins/google-business/security/change_2fa/
Content-Type: application/json

{
  "account_ids": [1, 2, 3],
  "browser_type": "geekez"  // 可选，不传则使用系统默认（优先 GeekezBrowser）
}
```

后端实现位置
- `Auto_All_System_Web/backend/plugins/google_business/views.py`
  - `SecurityViewSet.change_2fa`

该接口会：
1) 异步触发 Celery 任务 `google_business.security_change_2fa`
2) 将本次执行记录追加到账号 `metadata.google_zone_actions`（用于账号管理页“任务记录”展示）
3) 返回 celery task_id 给前端轮询

返回示例
```json
{
  "success": true,
  "task_id": "<celery-task-id>",
  "message": "2FA 修改任务已提交"
}
```

前端轮询任务状态
- `GET /api/v1/plugins/google-business/celery-tasks/{task_id}/`

## 2. Celery 任务总体流程

Celery 任务实现位置
- `Auto_All_System_Web/backend/plugins/google_business/tasks.py`
  - `security_change_2fa_task`（task name: `google_business.security_change_2fa`）

对每个账号的处理步骤
1) 从数据库读取账号 `GoogleAccount`
2) 解密账号密码与旧 2FA 密钥（若存在）
3) 获取浏览器实例（GeekezBrowser profile）并保证已登录
4) 调用安全设置服务执行 2FA 修改
5) 若成功，新的 2FA 密钥加密写回数据库
6) 返回结果列表（每个账号一条）

关键实现点：单 event loop
- Playwright 的 `page/context/browser` 等对象绑定 event loop。
- 任务中必须在同一个 `asyncio.run()` 生命周期内完成：
  - acquire -> login -> action -> release
- 对应代码采用 `run_all()` + `asyncio.run()` 的结构，避免跨 loop 导致卡死。

硬超时
- 任务对每个账号设置硬超时（防止无限 PROGRESS）。
- 超时时返回 `任务超时`，任务会进入终态（SUCCESS/FAILURE）。

## 3. 浏览器实例获取与登录

浏览器池
- `security_change_2fa_task` 内部通过 `browser_pool.acquire_by_email(...)` 获取实例。
- 该方法会确保 Geekez profile 存在并启动，随后 Playwright 通过 CDP 连接到浏览器。

登录
- 任务会先调用 `GoogleLoginService.check_login_status(page)` 检查是否已经登录。
- 未登录则调用 `GoogleLoginService.login(page, { email, password, secret, backup })`。

相关文件
- `Auto_All_System_Web/backend/plugins/google_business/services/browser_pool.py`
- `Auto_All_System_Web/backend/plugins/google_business/services/login_service.py`

## 4. 2FA 修改核心逻辑（页面自动化）

核心服务
- `Auto_All_System_Web/backend/plugins/google_business/services/security_service.py`
  - `GoogleSecurityService.change_2fa_secret(page, account)`

函数签名
```py
async def change_2fa_secret(
    page: Page,
    account: Dict[str, Any],
) -> Tuple[bool, str, Optional[str]]
```

返回值
- `success`: 是否成功
- `message`: 结果描述
- `new_secret`: 成功时返回新的 2FA secret（字符串）；失败为 None

自动化流程（高层）
1) 导航到 Google 两步验证页面
   - URL: `https://myaccount.google.com/signinoptions/two-step-verification`
2) 如出现密码二次验证页面，输入密码并提交
3) 进入 Authenticator app 配置入口（点击页面上的“Authenticator app”）
4) 尝试进入修改/重置流程（按钮可能是 “Change phone/更改手机” 等）
5) 点击 “Can't scan it?/无法扫描” 获取纯文本 secret
6) 从页面元素提取新的 secret
7) 使用 `pyotp.TOTP(new_secret)` 生成验证码并提交
8) 通过页面成功标识判断是否完成

注意：该流程对 Google 页面结构/语言敏感
- Google 的 UI 可能 A/B test，不同账号地区、不同语言会导致 selector 失效。
- 若出现 re-auth（再次要求密码/2FA）或额外安全校验，可能导致流程失败。

## 5. 2FA 密钥如何写回系统（新 2FA 从哪里来）

新的 2FA secret 来源
- `security_service.change_2fa_secret` 从页面元素抓取得到 `new_secret`

写回数据库
- `security_change_2fa_task` 在 `ok and new_secret` 时执行：
  - `GoogleAccount.two_fa_secret = EncryptionUtil.encrypt(new_secret)`
  - `GoogleAccount.two_fa_enabled = True`

写回位置
- `Auto_All_System_Web/backend/plugins/google_business/tasks.py`
  - `security_change_2fa_task`

返回给前端（敏感）
- 当前实现会在 Celery 任务结果中包含：
  - `results[].new_secret`
- 前端通过 `GET /celery-tasks/{task_id}/` 能看到结果。

安全提示
- `new_secret` 属于敏感信息。
- 建议后续策略：
  - 默认不在任务结果中回传明文，只落库
  - 或仅回传掩码/仅管理员可见
  - 导出时再解密输出

## 6. “请求了哪些接口”如何理解

后端直接请求的外部接口
- GeekezBrowser 控制 API（创建/启动 profile、查询 DevTools 端口等）
- 不会用 Python requests 直接调用 Google 的开放 API。

浏览器内部会请求 Google 私有接口
- 由于是 Playwright 控制页面，页面加载会触发大量 Google 内部请求（rpc/JSON 等）。
- 当前实现没有对 `page.on("request")/page.on("response")` 做全量记录，因此无法在代码层面列出所有 endpoint。
- 如需审计“到底请求了哪些 URL”，建议在调试模式下加入网络监听并落日志。

## 7. 常见失败原因与排查

1) 登录失败
- 账号需要人工验证码/安全校验
- 账号密码/2FA/恢复邮箱不正确

2) 2FA 页面元素变化
- “Authenticator app/Can't scan it/Done” 等文本在不同语言、不同 UI 版本下不一致
- selector 失效会导致 "未能获取新的 2FA 密钥"

3) re-auth 二次验证
- 修改 2FA 经常要求再次输入密码，甚至再次 2FA
- 当前 `change_2fa_secret` 只做了简单的密码检测，复杂 re-auth 需要增强

4) 任务超时
- 单账号硬超时触发，会返回 "任务超时"
- 需要查看 Celery 结果与任务日志定位卡在哪一步
