# 系统架构与配置文档

## 📊 系统概述

**项目名称**: Auto All System  
**技术栈**: Django 5.0 + Vue 3 + PostgreSQL 14 + Redis 7  
**部署方式**: Docker Compose  
**当前版本**: 1.0.0  
**更新日期**: 2026-01-19

---

## 🎯 技术栈

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vue 3** | 3.3.x | 前端框架 - 组合式API、TypeScript支持 |
| **TypeScript** | 5.x | 类型安全 - 编译时错误检查、代码提示 |
| **Element Plus** | 2.x | UI组件库 - 丰富的组件、响应式设计 |
| **Vite** | 5.x | 构建工具 - 快速开发、HMR |
| **Pinia** | 2.x | 状态管理 - Vue 3官方推荐 |
| **Vue Router** | 4.x | 路由管理 - SPA路由 |
| **Axios** | 1.x | HTTP客户端 - API请求 |

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Django** | 5.0 | Web框架 - ORM、Admin、中间件 |
| **Django REST Framework** | 3.14 | REST API - 序列化、视图集、认证 |
| **Celery** | 5.x | 异步任务 - 任务队列、定时任务 |
| **Python** | 3.10+ | 编程语言 |
| **PostgreSQL** | 14 | 主数据库 - 关系型数据库 |
| **Redis** | 7 | 缓存/消息队列 - Celery broker |

### 自动化工具

| 技术 | 版本 | 用途 |
|------|------|------|
| **Playwright** | 1.x | 浏览器自动化 - 页面操作、元素定位 |
| **BitBrowser API** | - | 浏览器指纹管理 - 防关联 |
| **pyotp** | 2.x | TOTP 2FA - Google Authenticator |
| **deep-translator** | 1.x | 多语言翻译 - 13种语言支持 |

### 容器化和部署

| 技术 | 版本 | 用途 |
|------|------|------|
| **Docker** | 20.x | 容器化 - 环境隔离 |
| **Docker Compose** | 2.x | 多容器编排 - 服务管理 |
| **Nginx** | 1.24 | Web服务器 - 反向代理、静态文件 |

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户浏览器                             │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/HTTPS
                     ▼
┌─────────────────────────────────────────────────────────┐
│              Nginx (端口80/443)                          │
│         - 静态文件服务 (Vue前端)                          │
│         - 反向代理 (Django后端)                           │
│         - SSL终止 (可选)                                 │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP
                     ▼
┌─────────────────────────────────────────────────────────┐
│           Django Backend (端口8000)                      │
│         - REST API                                       │
│         - 业务逻辑                                        │
│         - 任务调度                                        │
└───┬─────────────────┬────────────────┬──────────────────┘
    │                 │                │
    ▼                 ▼                ▼
┌─────────┐   ┌──────────────┐   ┌────────────┐
│PostgreSQL│   │    Redis     │   │   Celery   │
│  数据库  │   │    缓存      │   │   Worker   │
│ 端口5432 │   │   端口6379   │   │  异步任务  │
└─────────┘   └──────────────┘   └────────────┘
```

### 服务组件说明

| 服务 | 技术 | 端口 | 说明 |
|------|------|------|------|
| **frontend** | Vue3 + Nginx | 80/443 | Web前端 + 静态文件服务 |
| **backend** | Django 5.0 | 8000 | REST API后端服务 |
| **db** | PostgreSQL 14 | 5432 | 主数据库 |
| **redis** | Redis 7 | 6379 | 缓存 + 消息队列 |
| **celery** | Celery Worker | - | 异步任务处理 |
| **celery-beat** | Celery Beat | - | 定时任务调度 |

---

## 🌐 访问地址

### 开发环境

| 服务 | 地址 | 说明 |
|------|------|------|
| **前端应用** | http://localhost | Vue3单页应用 |
| **管理后台** | http://localhost/admin | 用户端管理后台 |
| **后端API** | http://localhost:8000/api/ | RESTful API |
| **API文档** | http://localhost:8000/api/docs/ | Swagger文档 |
| **健康检查** | http://localhost:8000/api/health/ | 服务健康状态 |
| **Nginx代理健康检查** | http://localhost/api/health/ | 通过Nginx访问 |

### 生产环境

替换 `localhost` 为实际域名即可。

---

## ⚙️ 核心配置说明

### 1. HTTP/HTTPS 配置

#### 架构设计

**SSL/HTTPS完全由Nginx控制，Django后端信任代理头**

```
客户端 <--[HTTP/HTTPS]--> Nginx <--[HTTP]--> Django后端
```

**优势**:
- ✅ 标准的生产环境架构
- ✅ Django只需要处理业务逻辑
- ✅ Nginx负责SSL终止和安全防护
- ✅ 灵活切换HTTP/HTTPS模式

#### 当前模式: HTTP (开发环境)

**配置文件**: `docker-compose.yml`

```yaml
backend:
  environment:
    - ENABLE_HTTPS=false  # false=HTTP模式, true=HTTPS模式
```

**Nginx配置**: `frontend/nginx.conf`

```nginx
server {
    listen 80;
    server_name localhost;
    
    # 代理后端API
    location /api/ {
        proxy_pass http://backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;  # 关键！
    }
}
```

#### 启用HTTPS模式

##### 步骤1: 准备SSL证书

**开发环境 - 自签名证书**:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx-selfsigned.key \
  -out nginx-selfsigned.crt \
  -subj "/CN=localhost"
```

**生产环境 - Let's Encrypt**:
```bash
certbot certonly --standalone -d yourdomain.com
```

##### 步骤2: 修改Nginx配置

```nginx
server {
    listen 80;
    server_name localhost;
    return 301 https://$server_name$request_uri;  # 重定向到HTTPS
}

server {
    listen 443 ssl http2;
    server_name localhost;
    
    # SSL证书
    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # ... 其他配置
}
```

##### 步骤3: 修改docker-compose.yml

```yaml
frontend:
  ports:
    - "80:80"
    - "443:443"  # 添加443端口
  volumes:
    - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf
    - ./ssl:/etc/nginx/ssl  # 挂载证书目录

backend:
  environment:
    - ENABLE_HTTPS=true  # 启用HTTPS模式
```

##### 步骤4: 重启服务

```bash
docker-compose down
docker-compose up -d --build
```

### 2. Django配置

**位置**: `backend/config/settings/base.py`

```python
# 代理配置 - 信任来自Nginx的头信息
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
USE_X_FORWARDED_HOST = True
USE_X_FORWARDED_PORT = True

# Cookie安全性 - 根据环境变量动态控制
SESSION_COOKIE_SECURE = os.getenv('ENABLE_HTTPS', 'false').lower() == 'true'
CSRF_COOKIE_SECURE = os.getenv('ENABLE_HTTPS', 'false').lower() == 'true'

# CORS配置
CORS_ALLOWED_ORIGINS = [
    "http://localhost",
    "https://localhost",
]

# 允许的主机
ALLOWED_HOSTS = ['*']  # 生产环境应设置为具体域名

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('DB_NAME', 'auto_all_db'),
        'USER': os.getenv('DB_USER', 'auto_all_user'),
        'PASSWORD': os.getenv('DB_PASSWORD', 'your_password_here'),
        'HOST': os.getenv('DB_HOST', 'db'),
        'PORT': os.getenv('DB_PORT', '5432'),
    }
}

# Redis配置
REDIS_URL = os.getenv('REDIS_URL', 'redis://redis:6379/1')

# Celery配置
CELERY_BROKER_URL = REDIS_URL
CELERY_RESULT_BACKEND = REDIS_URL
```

### 3. 环境变量配置

**位置**: `docker-compose.yml`

```yaml
backend:
  environment:
    # 数据库配置
    - DB_HOST=db
    - DB_NAME=auto_all_db
    - DB_USER=auto_all_user
    - DB_PASSWORD=your_password_here
    - DB_PORT=5432
    
    # Redis配置
    - REDIS_URL=redis://redis:6379/1
    
    # HTTPS控制
    - ENABLE_HTTPS=false
    
    # 加密密钥
    - SECRET_KEY=your-secret-key-here
    - ENCRYPTION_KEY=your-encryption-key-here
    
    # 环境类型
    - DJANGO_SETTINGS_MODULE=config.settings.production
```

---

## 🚀 部署指南

### Docker部署 (推荐)

#### 启动系统

```powershell
# 在 Auto_All_System 目录下
cd Auto_All_System

# 首次启动（构建镜像）
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 初始化数据

```bash
# 创建数据库表
docker-compose exec backend python manage.py migrate

# 创建超级用户
docker-compose exec backend python manage.py createsuperuser

# 收集静态文件
docker-compose exec backend python manage.py collectstatic --no-input
```

#### 停止系统

```powershell
docker-compose down
```

### 本地开发部署

#### 后端开发

```bash
cd backend

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements/development.txt

# 配置环境变量
cp env_example.txt .env
# 编辑 .env 文件

# 启动开发服务器
python manage.py runserver

# 启动Celery Worker (新终端)
celery -A config worker -l info

# 启动Celery Beat (新终端)
celery -A config beat -l info
```

#### 前端开发

```bash
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

---

## 📁 目录结构

```
Auto_All_System/
├── backend/                 # Django后端
│   ├── apps/               # 应用模块
│   │   ├── accounts/      # 用户账户
│   │   ├── zones/         # 专区管理
│   │   ├── tasks/         # 任务管理
│   │   ├── cards/         # 虚拟卡管理
│   │   ├── payments/      # 支付订单
│   │   └── integrations/  # 第三方集成
│   │       ├── proxies/           # 代理管理
│   │       ├── google_accounts/   # Google账号
│   │       └── bitbrowser/        # 比特浏览器
│   ├── config/            # 项目配置
│   │   ├── settings/     # 设置文件
│   │   │   ├── base.py          # 基础设置
│   │   │   ├── development.py   # 开发环境
│   │   │   └── production.py    # 生产环境
│   │   ├── urls.py       # 路由配置
│   │   └── celery.py     # Celery配置
│   ├── core/              # 核心功能
│   ├── requirements/      # 依赖文件
│   │   ├── base.txt             # 基础依赖
│   │   └── development.txt      # 开发依赖
│   ├── manage.py          # Django管理脚本
│   └── Dockerfile         # Docker配置
│
├── frontend/               # Vue3前端
│   ├── src/
│   │   ├── api/          # API接口
│   │   ├── components/   # 公共组件
│   │   ├── layouts/      # 布局组件
│   │   ├── router/       # 路由配置
│   │   ├── stores/       # 状态管理
│   │   ├── types/        # TypeScript类型
│   │   └── views/        # 页面组件
│   │       ├── auth/            # 认证页面
│   │       ├── user/            # 用户页面
│   │       └── admin/           # 管理后台
│   ├── nginx.conf        # Nginx配置
│   ├── package.json      # 依赖配置
│   └── Dockerfile        # Docker配置
│
├── 文档/                  # 项目文档
│   ├── 01-数据库设计文档.md
│   ├── 02-系统架构与配置.md
│   └── ...
│
├── docker-compose.yml     # Docker Compose配置
└── README.md             # 项目说明
```

---

## 🔒 安全配置

### 生产环境必做

1. **修改默认密码**
   ```yaml
   # docker-compose.yml
   - DB_PASSWORD=使用强密码
   - SECRET_KEY=使用随机生成的长密钥
   - ENCRYPTION_KEY=使用随机生成的密钥
   ```

2. **设置ALLOWED_HOSTS**
   ```python
   # settings/production.py
   ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']
   ```

3. **启用HTTPS**
   - 参考上文HTTPS配置章节

4. **配置防火墙**
   ```bash
   # 只暴露必要端口
   ufw allow 80/tcp
   ufw allow 443/tcp
   ufw deny 8000/tcp  # 不要直接暴露后端端口
   ufw deny 5432/tcp  # 不要直接暴露数据库端口
   ```

5. **限制访问来源**
   - 在Nginx中配置IP白名单
   - 使用VPN或堡垒机访问管理后台

### 数据加密

以下字段已加密存储：
- 虚拟卡号和CVV
- Google账号密码和2FA密钥
- API密钥
- 代理密码

**加密方法**: Fernet (对称加密)

---

## 📊 性能优化

### 数据库优化

1. **连接池配置**
   ```python
   DATABASES = {
       'default': {
           'CONN_MAX_AGE': 600,  # 连接复用
       }
   }
   ```

2. **索引优化**
   - 所有外键已添加索引
   - 高频查询字段已添加索引
   - 参考数据库设计文档

3. **查询优化**
   ```python
   # 使用select_related减少查询
   Task.objects.select_related('user', 'zone').all()
   
   # 使用prefetch_related优化多对多
   User.objects.prefetch_related('tasks').all()
   ```

### Redis缓存

```python
# 缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': REDIS_URL,
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# 使用示例
from django.core.cache import cache

# 设置缓存
cache.set('key', 'value', 300)  # 5分钟

# 获取缓存
value = cache.get('key')
```

### Celery优化

```python
# 并发数配置
CELERY_WORKER_CONCURRENCY = 4  # 根据CPU核心数调整

# 任务超时
CELERY_TASK_TIME_LIMIT = 300  # 5分钟

# 结果过期
CELERY_RESULT_EXPIRES = 3600  # 1小时
```

---

## 🧪 健康检查

### API端点

```bash
curl http://localhost:8000/api/health/
```

**响应示例**:
```json
{
  "status": "healthy",
  "timestamp": "2026-01-16T12:00:00Z",
  "database": "connected",
  "cache": "connected",
  "celery": "running"
}
```

### Docker健康检查

```yaml
# docker-compose.yml
backend:
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
    interval: 30s
    timeout: 10s
    retries: 3
```

---

## 📝 常用命令

### Docker命令

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 重新构建并启动
docker-compose up -d --build

# 进入容器
docker-compose exec [service_name] bash
```

### Django命令

```bash
# 创建迁移
docker-compose exec backend python manage.py makemigrations

# 应用迁移
docker-compose exec backend python manage.py migrate

# 创建超级用户
docker-compose exec backend python manage.py createsuperuser

# Django Shell
docker-compose exec backend python manage.py shell

# 收集静态文件
docker-compose exec backend python manage.py collectstatic
```

### 数据库命令

```bash
# 进入PostgreSQL
docker-compose exec db psql -U auto_all_user -d auto_all_db

# 备份数据库
docker-compose exec db pg_dump -U auto_all_user auto_all_db > backup.sql

# 恢复数据库
docker-compose exec -T db psql -U auto_all_user auto_all_db < backup.sql
```

---

## 🐛 故障排除

### 服务无法启动

```bash
# 查看详细日志
docker-compose logs -f

# 检查容器状态
docker-compose ps

# 重新构建
docker-compose down
docker-compose up -d --build
```

### 端口被占用

修改 `docker-compose.yml`:
```yaml
ports:
  - "8080:80"   # 前端改为8080
  - "8001:8000" # 后端改为8001
```

### 数据库连接失败

```bash
# 检查数据库服务
docker-compose logs db

# 重启数据库
docker-compose restart db

# 验证连接
docker-compose exec backend python manage.py dbshell
```

### Redis连接失败

```bash
# 检查Redis服务
docker-compose logs redis

# 测试连接
docker-compose exec redis redis-cli ping
```

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-16  
**维护者**: Auto All System Team

