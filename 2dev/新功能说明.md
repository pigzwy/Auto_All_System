# Google安全自动化 - 新功能说明

## 更新内容

### 1. ✅ 辅助邮箱修改 - 全自动模式（支持IMAP验证码自动读取）

**之前**：半自动模式，需要手动输入验证码
**现在**：全自动模式，通过IMAP自动从163邮箱读取Google发送的验证码

#### 配置方法

1. **编辑 `email_config.ini` 文件**：
```ini
[imap_163]
email = chujian123qwe@163.com
password = NGtB4HF8KPtD9MKC  # 这是授权码，不是登录密码

[domain_email]
domain = xiaochujian.asia
```

2. **获取163邮箱授权码的步骤**：
   - 登录163邮箱网页版
   - 进入 设置 → POP3/SMTP/IMAP
   - 开启IMAP/SMTP服务
   - 生成授权码（注意保存，只显示一次）

3. **域名邮箱中转说明**：
   - 所有发送到 `*@xiaochujian.asia` 的邮件会自动转发到 `chujian123qwe@163.com`
   - 因此，设置辅助邮箱时使用 `test@xiaochujian.asia` 这样的地址
   - 脚本会自动从163邮箱中读取验证码

#### 使用示例

```python
from google_security_automation import change_recovery_email, load_imap_config
import asyncio

async def main():
    # 账号信息
    account_info = {
        'email': 'your@gmail.com',
        'password': 'your_password',
        'secret': 'your_2fa_secret'
    }
    
    # 新辅助邮箱（使用域名邮箱）
    new_email = 'test@xiaochujian.asia'
    
    # 加载IMAP配置
    imap_config = load_imap_config()
    
    # 执行修改（全自动）
    success, message = await change_recovery_email(
        browser_id='YOUR_BROWSER_ID',
        account_info=account_info,
        new_email=new_email,
        log_callback=print,
        imap_config=imap_config  # 传入IMAP配置实现自动读取验证码
    )
    
    if success:
        print(f"✅ 成功: {message}")
    else:
        print(f"❌ 失败: {message}")

asyncio.run(main())
```

#### 工作流程

1. 脚本访问Google Personal Info页面
2. 点击 "Recovery email"
3. 自动处理密码/2FA验证
4. 点击编辑按钮（铅笔图标）
5. 输入新邮箱地址（例如 `test@xiaochujian.asia`）
6. 点击 "Save"
7. **自动从163邮箱读取验证码** 🎉
8. 自动输入验证码并确认
9. 完成！

### 2. ✅ Backup Codes 提取 - 修复显示格式

**之前**：可能显示多个数字组合在一起
**现在**：正确显示10个独立的备份码

#### 改进内容

- 使用更精确的正则表达式提取
- 添加去重逻辑（使用set）
- 分两步提取：先从页面文本，再从DOM元素
- 显示调试信息，列出所有提取到的备份码
- 确保严格限制为10个

#### 输出示例

```
🔑 提取备份验证码...
   方法1提取到 10 个备份码
📋 提取到的备份码:
   1. 1234 5678
   2. 2345 6789
   3. 3456 7890
   4. 4567 8901
   5. 5678 9012
   6. 6789 0123
   7. 7890 1234
   8. 8901 2345
   9. 9012 3456
   10. 0123 4567
✅ 成功提取到 10 个备份验证码
```

### 3. ✅ 修复辅助邮箱修改流程

使用你提供的正确元素定位器：

1. **Recovery email** 点击器：`<div class="IlKlLe">Recovery email</div>`
2. **编辑按钮**（铅笔图标）：`<div class="pYTkkf-Bz112c-RLmnJb"></div>`
3. **Save 按钮**：`<span jsname="V67aGc" class="UywwFc-vQzf8d">Save</span>`

现在流程会更稳定可靠！

## 文件说明

### 新增文件

1. **`email_verifier.py`** - IMAP邮件验证码读取模块
   - 封装IMAP连接和邮件读取逻辑
   - 自动提取Google验证码
   - 支持重试和超时控制

2. **`email_config.ini`** - 163邮箱IMAP配置
   - 存储163邮箱地址和授权码
   - 配置域名邮箱信息

3. **`test_email_features.py`** - 功能测试脚本
   - 测试IMAP连接
   - 演示使用方法
   - 验证Backup codes格式

### 修改文件

1. **`google_security_automation.py`**
   - 添加 `load_imap_config()` 函数
   - 更新 `change_recovery_email()` 支持IMAP自动验证
   - 改进 `get_backup_codes()` 提取逻辑
   - 更新 `one_click_security_update()` 支持IMAP配置

## 测试方法

### 方法1: 运行测试脚本

```bash
python test_email_features.py
```

这会测试：
- IMAP连接是否正常
- 配置文件是否正确加载
- Backup codes格式化

### 方法2: 在GUI中测试

1. 确保 `email_config.ini` 配置正确
2. 在GUI中选择账号
3. 使用 "一键修改" 功能
4. 观察日志输出，应该会看到 "🤖 使用IMAP自动读取验证码..."

## 注意事项

⚠️ **重要提醒**：

1. **授权码不是登录密码**：163邮箱的授权码是专门用于第三方应用的独立密码
2. **域名邮箱配置**：确保域名邮箱的MX记录正确配置了邮件转发
3. **验证码有效期**：Google验证码通常在10分钟内有效，脚本会在120秒内轮询
4. **IMAP端口**：163邮箱IMAP使用 `imap.163.com:993` (SSL)
5. **防火墙**：确保防火墙允许IMAP连接（端口993）

## 故障排查

### IMAP连接失败

```
❌ IMAP连接失败: [AUTHENTICATIONFAILED] ...
```

**解决方法**：
- 检查授权码是否正确（不是登录密码）
- 确认IMAP服务已在163邮箱中开启
- 重新生成授权码

### 未收到验证码

```
❌ 超时：在 120 秒内未找到验证码
```

**解决方法**：
- 检查域名邮箱转发是否正常
- 手动发送测试邮件到 `test@xiaochujian.asia`，检查是否能收到
- 查看163邮箱垃圾邮件文件夹
- 增加timeout参数

### Backup codes 不是10个

**解决方法**：
- 查看调试日志，检查 "📋 提取到的备份码" 部分
- 如果提取到重复的码，已有去重逻辑
- 如果提取到错误的数字，检查页面HTML结构是否变化

## 下一步优化建议

1. **支持更多邮箱服务商**：
   - QQ邮箱
   - Gmail (IMAP)
   - Outlook

2. **增强验证码识别**：
   - 支持更多验证码格式
   - 智能识别不同语言的验证码邮件

3. **添加邮箱池管理**：
   - 自动轮换辅助邮箱
   - 记录使用历史
   - 避免重复使用

4. **GUI集成**：
   - 在GUI中添加IMAP配置界面
   - 实时显示验证码读取进度
   - 提供手动/自动切换选项

## 联系支持

如有问题，请检查：
1. 日志输出（包含详细的步骤信息）
2. `email_config.ini` 配置
3. 163邮箱IMAP服务状态

---

更新日期：2026-01-14
版本：v2.0 (IMAP自动验证版本)
