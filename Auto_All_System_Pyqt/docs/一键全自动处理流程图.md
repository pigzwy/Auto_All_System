# 一键全自动处理流程图

## 整体流程概览

```mermaid
flowchart TB
    subgraph 初始化["🚀 初始化阶段"]
        START([开始]) --> INIT[获取账号/卡片/API信息]
        INIT --> OPEN_BROWSER[打开浏览器]
        OPEN_BROWSER --> |失败| RETRY_BROWSER{重试?}
        RETRY_BROWSER --> |是| OPEN_BROWSER
        RETRY_BROWSER --> |否| ERROR_EXIT([❌ 退出])
    end

    subgraph 登录检测["🔐 登录检测阶段"]
        OPEN_BROWSER --> |成功| NAV_PAGE[导航到资格页面]
        NAV_PAGE --> CHECK_LOGIN{检测登录状态}
        CHECK_LOGIN --> |已登录| CHECK_ELIGIBILITY
        CHECK_LOGIN --> |未登录| DO_LOGIN[执行登录流程]
        
        DO_LOGIN --> INPUT_EMAIL[输入邮箱]
        INPUT_EMAIL --> INPUT_PWD[输入密码]
        INPUT_PWD --> POST_PWD{密码后验证}
        
        POST_PWD --> |需要2FA| INPUT_2FA[输入2FA验证码]
        POST_PWD --> |需要辅助邮箱| INPUT_BACKUP[确认辅助邮箱]
        POST_PWD --> |有弹窗| HANDLE_POPUP[处理弹窗]
        POST_PWD --> |密码错误| LOGIN_ERROR[登录失败]
        POST_PWD --> |成功| CHECK_ELIGIBILITY
        
        INPUT_2FA --> POST_PWD
        INPUT_BACKUP --> POST_PWD
        HANDLE_POPUP --> POST_PWD
        
        LOGIN_ERROR --> RETRY_LOGIN{重试登录?}
        RETRY_LOGIN --> |是| DO_LOGIN
        RETRY_LOGIN --> |否| UPDATE_STATUS_LOGIN[更新状态: 未登录]
        UPDATE_STATUS_LOGIN --> CLOSE_BROWSER_1([关闭浏览器])
    end

    subgraph 资格检测["🔍 资格检测阶段"]
        CHECK_ELIGIBILITY{检测资格状态}
        
        CHECK_ELIGIBILITY --> |已订阅+解锁| STATUS_ANTIGRAVITY[🌟 已订阅已解锁]
        CHECK_ELIGIBILITY --> |已订阅| STATUS_SUBSCRIBED[👑 已订阅]
        CHECK_ELIGIBILITY --> |已验证未绑卡| STATUS_VERIFIED[✅ 已验证]
        CHECK_ELIGIBILITY --> |有资格待验证| STATUS_LINK_READY[🔗 待验证]
        CHECK_ELIGIBILITY --> |无资格| STATUS_INELIGIBLE[❌ 无资格]
        CHECK_ELIGIBILITY --> |检测失败| RETRY_ELIGIBILITY{重试检测?}
        
        RETRY_ELIGIBILITY --> |是| CHECK_ELIGIBILITY
        RETRY_ELIGIBILITY --> |否| UPDATE_STATUS_ERROR[更新状态: 错误]
        UPDATE_STATUS_ERROR --> CLOSE_BROWSER_2([关闭浏览器])
        
        STATUS_ANTIGRAVITY --> UPDATE_DB_1[更新数据库]
        STATUS_SUBSCRIBED --> UPDATE_DB_2[更新数据库]
        STATUS_INELIGIBLE --> UPDATE_DB_3[更新数据库]
        
        UPDATE_DB_1 --> SUCCESS_EXIT([✅ 完成])
        UPDATE_DB_2 --> SUCCESS_EXIT
        UPDATE_DB_3 --> CLOSE_BROWSER_3([关闭浏览器])
    end

    subgraph SheerID验证["🔄 SheerID验证阶段"]
        STATUS_LINK_READY --> EXTRACT_LINK[提取SheerID链接]
        EXTRACT_LINK --> HAS_API_KEY{有API Key?}
        
        HAS_API_KEY --> |否| SAVE_LINK_ONLY[仅保存链接]
        SAVE_LINK_ONLY --> UPDATE_DB_LINK[更新数据库: 待验证]
        UPDATE_DB_LINK --> PARTIAL_SUCCESS([⚠️ 部分完成])
        
        HAS_API_KEY --> |是| EXTRACT_VID[提取验证ID]
        EXTRACT_VID --> CALL_SHEERID_API[调用SheerID API]
        CALL_SHEERID_API --> SHEERID_RESULT{验证结果}
        
        SHEERID_RESULT --> |成功| RELOAD_PAGE[刷新页面]
        SHEERID_RESULT --> |失败| RETRY_SHEERID{重试验证?}
        
        RETRY_SHEERID --> |是| CALL_SHEERID_API
        RETRY_SHEERID --> |否| UPDATE_DB_FAIL[更新: 验证失败]
        UPDATE_DB_FAIL --> CLOSE_BROWSER_4([关闭浏览器])
        
        RELOAD_PAGE --> RECHECK_STATUS[重新检测状态]
        RECHECK_STATUS --> |已验证| GO_BIND_CARD
        RECHECK_STATUS --> |其他| UPDATE_DB_NEW[更新新状态]
        UPDATE_DB_NEW --> CLOSE_BROWSER_5([关闭浏览器])
    end

    subgraph 绑卡订阅["💳 绑卡订阅阶段"]
        STATUS_VERIFIED --> GO_BIND_CARD[开始绑卡流程]
        GO_BIND_CARD --> HAS_CARD{有卡片信息?}
        
        HAS_CARD --> |否| NO_CARD_EXIT[无可用卡片]
        NO_CARD_EXIT --> UPDATE_DB_VERIFIED[更新: 已验证]
        UPDATE_DB_VERIFIED --> CLOSE_BROWSER_6([关闭浏览器])
        
        HAS_CARD --> |是| CLICK_GET_OFFER[点击Get Student Offer]
        CLICK_GET_OFFER --> WAIT_IFRAME[等待支付iframe]
        WAIT_IFRAME --> CHECK_EXIST_CARD{已有绑卡?}
        
        CHECK_EXIST_CARD --> |是| CLICK_CHANGE[点击Change Payment]
        CHECK_EXIST_CARD --> |否| CLICK_ADD_CARD[点击Add Card]
        
        CLICK_CHANGE --> CLICK_ADD_CARD
        CLICK_ADD_CARD --> ENTER_IFRAME[进入嵌套iframe]
        
        ENTER_IFRAME --> FILL_CARD_NUMBER[填写卡号]
        FILL_CARD_NUMBER --> FILL_EXP_DATE[填写有效期]
        FILL_EXP_DATE --> FILL_CVV[填写CVV]
        FILL_CVV --> CHECK_ZIP{需要邮编?}
        
        CHECK_ZIP --> |是| FILL_ZIP[填写邮编]
        CHECK_ZIP --> |否| SAVE_CARD
        FILL_ZIP --> SAVE_CARD[点击Save Card]
        
        SAVE_CARD --> WAIT_SAVE{保存成功?}
        WAIT_SAVE --> |超时| RETRY_SAVE{重试保存?}
        RETRY_SAVE --> |是| SAVE_CARD
        RETRY_SAVE --> |否| BIND_FAIL[绑卡失败]
        
        WAIT_SAVE --> |成功| EXIT_IFRAME[退出iframe]
        EXIT_IFRAME --> CLICK_SUBSCRIBE[点击Subscribe]
        
        CLICK_SUBSCRIBE --> SUBSCRIBE_RESULT{订阅结果}
        SUBSCRIBE_RESULT --> |成功| UPDATE_CARD_USAGE[更新卡片使用次数]
        SUBSCRIBE_RESULT --> |失败| RETRY_SUBSCRIBE{重试订阅?}
        
        RETRY_SUBSCRIBE --> |是| CLICK_SUBSCRIBE
        RETRY_SUBSCRIBE --> |否| SUBSCRIBE_FAIL[订阅失败]
        
        UPDATE_CARD_USAGE --> UPDATE_DB_SUBSCRIBED[更新: 已订阅]
        UPDATE_DB_SUBSCRIBED --> SUCCESS_EXIT_2([✅ 完成])
        
        BIND_FAIL --> UPDATE_DB_BIND_FAIL[更新: 绑卡失败]
        SUBSCRIBE_FAIL --> UPDATE_DB_SUB_FAIL[更新: 订阅失败]
        UPDATE_DB_BIND_FAIL --> CLOSE_BROWSER_7([关闭浏览器])
        UPDATE_DB_SUB_FAIL --> CLOSE_BROWSER_8([关闭浏览器])
    end

    style START fill:#4CAF50,color:#fff
    style SUCCESS_EXIT fill:#4CAF50,color:#fff
    style SUCCESS_EXIT_2 fill:#4CAF50,color:#fff
    style PARTIAL_SUCCESS fill:#FF9800,color:#fff
    style ERROR_EXIT fill:#f44336,color:#fff
    style CLOSE_BROWSER_1 fill:#f44336,color:#fff
    style CLOSE_BROWSER_2 fill:#f44336,color:#fff
    style CLOSE_BROWSER_3 fill:#FF9800,color:#fff
    style CLOSE_BROWSER_4 fill:#f44336,color:#fff
    style CLOSE_BROWSER_5 fill:#FF9800,color:#fff
    style CLOSE_BROWSER_6 fill:#FF9800,color:#fff
    style CLOSE_BROWSER_7 fill:#f44336,color:#fff
    style CLOSE_BROWSER_8 fill:#f44336,color:#fff
```

## 步骤状态定义

| 步骤代码 | 步骤名称 | 说明 |
|---------|---------|------|
| `init` | 初始化 | 获取账号、卡片、API信息 |
| `open_browser` | 打开浏览器 | 通过BitBrowser API打开浏览器 |
| `navigate` | 导航页面 | 导航到Google One资格页面 |
| `check_login` | 检测登录 | 检测是否已登录Google账号 |
| `do_login` | 执行登录 | 执行Google登录流程 |
| `handle_2fa` | 处理2FA | 处理两步验证 |
| `handle_backup` | 辅助邮箱 | 确认辅助邮箱验证 |
| `check_eligibility` | 检测资格 | 检测Google One学生资格 |
| `extract_link` | 提取链接 | 提取SheerID验证链接 |
| `verify_sheerid` | SheerID验证 | 调用API验证学生身份 |
| `bind_card` | 绑定卡片 | 填写并绑定支付卡 |
| `subscribe` | 订阅服务 | 完成订阅流程 |
| `complete` | 完成 | 流程结束 |

## 重试策略

| 操作 | 最大重试次数 | 重试间隔 | 说明 |
|-----|------------|---------|------|
| 打开浏览器 | 3 | 2秒 | 浏览器启动失败时重试 |
| 登录流程 | 3 | 1秒 | 登录失败时重试 |
| 2FA验证 | 5 | 30秒 | 等待TOTP码刷新 |
| 资格检测 | 2 | 3秒 | 页面加载问题重试 |
| SheerID验证 | 2 | 5秒 | API调用失败重试 |
| 绑卡操作 | 3 | 2秒 | iframe加载或输入问题 |
| 订阅操作 | 2 | 3秒 | 订阅按钮响应问题 |

## 错误处理

```mermaid
flowchart LR
    ERROR[发生错误] --> TYPE{错误类型}
    
    TYPE --> |网络超时| RETRY_NET[等待后重试]
    TYPE --> |元素未找到| RETRY_ELEM[刷新重试]
    TYPE --> |验证失败| LOG_FAIL[记录失败]
    TYPE --> |API错误| RETRY_API[延迟重试]
    TYPE --> |致命错误| ABORT[中止流程]
    
    RETRY_NET --> CHECK_RETRY{超过重试次数?}
    RETRY_ELEM --> CHECK_RETRY
    RETRY_API --> CHECK_RETRY
    
    CHECK_RETRY --> |否| CONTINUE[继续执行]
    CHECK_RETRY --> |是| LOG_FAIL
    
    LOG_FAIL --> UPDATE_DB[更新数据库状态]
    ABORT --> UPDATE_DB
    UPDATE_DB --> CLOSE[关闭浏览器]
```

## 状态流转图

```mermaid
stateDiagram-v2
    [*] --> pending: 导入账号
    
    pending --> not_logged_in: 登录失败
    pending --> ineligible: 无资格
    pending --> link_ready: 有资格待验证
    pending --> verified: 已验证
    pending --> subscribed: 已订阅
    pending --> subscribed_antigravity: 已解锁
    pending --> error: 检测错误
    
    not_logged_in --> pending: 重新检测
    
    link_ready --> verified: SheerID验证成功
    link_ready --> error: 验证失败
    
    verified --> subscribed: 绑卡成功
    verified --> error: 绑卡失败
    
    subscribed --> subscribed_antigravity: 解锁Antigravity
    
    error --> pending: 重新检测
    
    subscribed_antigravity --> [*]: 完成
```
